{% extends "base.html" %}

{% block title %}Home - FoodFinder{% endblock %}

{% load static%}

{% block css%}
    <link rel="stylesheet" href="{% static 'home_nav_bar.css' %}">
    <link rel="stylesheet" href="{% static 'restaurant_card.css' %}">
{% endblock%}

{% block content %}
    <div class="content-wrapper">
        <div class="main-container">
            <div class="left-container">
                <h2>Welcome to FoodFinder!</h2>
                <p><i>{{ user.username }}'s go-to destination for discovering great food, brought to you by Group 42.</i></p>
                <p>
                    Start by searching for a restaurant or a type of cuisine. Once you've found what you're looking for, you can sort the results by ratings, distance, or other criteria to narrow down your choices. <br><br>
                    Need directions? You can seamlessly view the restaurant's location on Google Maps and get directions with one click. <br><br>
                    Love a place? Add it to your favorites so you can easily find it later!
                </p>

                <!-- Search bar -->
                <form id="search-form">
                    <div class="search-container">
                        <input type="text" id="search-query" placeholder="Search for restaurants..." required>
                        <button type="submit">Search</button>
                    </div>
                    <div>
                        <label for="search-radius">Search radius (miles):</label>
                        <input type="number" id="search-radius" value="5" min="1" step="1">
                    </div>
                </form>
                
                <div id="sort-options" style="display: none;">
                    <label for="sort-select">Sort by:</label>
                    <select id="sort-select">
                        <option value="default">Relevance</option>
                        <option value="price">Price (Low to High)</option>
                        <option value="distance">Distance</option>
                        <option value="rating">Rating (High to Low)</option>
                    </select>
                </div>

                <!-- Output window where search results will be displayed -->
                <div id="output-window">
                    <ul id="results-list"></ul>
                </div>
            </div>

            <div class="right-container">
                <div id="map" style="height: 700px; width: 800px;"></div> <!-- Adjust height as needed -->
            </div>

            <script>
                // Declare global variables
                let googleMapsApi;
                let placesService;
                let currentResults = [];
                let userPosition;
                let markers = [];

                function getUrlParameter(name) {
                    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                    var results = regex.exec(location.search);
                    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
                }
                
                function initMap() {
                    console.log("Google Maps API loaded.");
                    googleMapsApi = google;
                    placesService = new google.maps.places.PlacesService(document.createElement('div'));
                
                    const defaultLocation = { lat: 33.777013, lng: -84.398807 }; // Default to Atlanta, adjust as needed
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: defaultLocation,
                        zoom: 12,
                    });
                
                    const restaurantName = getUrlParameter('restaurant_name');
                
                    if (restaurantName) {
                        // If there's a specific restaurant to be shown, search only for that restaurant
                        searchRestaurants(restaurantName, true);
                    } else {
                        // Attach search form event listener if it's a general search
                        document.getElementById('search-form').addEventListener('submit', function(event) {
                            console.log("Form submitted.");
                            event.preventDefault();
                            const query = document.getElementById('search-query').value;
                            searchRestaurants(query);
                        });
                
                        // Add event listener for sorting
                        document.getElementById('sort-select').addEventListener('change', function() {
                            sortAndDisplayResults(this.value);
                        });
                    }
                }
                
                // Function to initialize Google Maps API when the page loads
                function loadGoogleMapsApi() {
                    const script = document.createElement('script');
                    script.src = 'https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places,geometry&callback=initMap';
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                }
                
                window.onload = loadGoogleMapsApi;

                document.getElementById('search-form').addEventListener('submit', function(event) {
                    event.preventDefault(); // Prevent the default form submission
                    const query = document.getElementById('search-query').value;
                
                    // Call your search function
                    searchRestaurants(query);
                
                    // Scroll to the output window while accounting for top padding
                    const outputWindow = document.getElementById('output-window');
                    const offsetTop = outputWindow.getBoundingClientRect().top + window.scrollY - 20; // Adjust the 20 based on your padding
                    window.scrollTo({ top: offsetTop, behavior: 'smooth' });
                });
                
                // Function to clear existing markers
                function clearMarkers() {
                    for (let i = 0; i < markers.length; i++) {
                        markers[i].setMap(null); // Remove marker from the map
                    }
                    markers = []; // Reset the markers array
                }
                

                function searchRestaurants(query, specificRestaurant = false) {
                    console.log("Searching for restaurants:", query);
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            userPosition = position;
                            const userLocation = new google.maps.LatLng(
                                position.coords.latitude,
                                position.coords.longitude
                            );
                
                            const radiusInMiles = document.getElementById('search-radius').value;
                            const radiusInMeters = radiusInMiles * 1609.34;
                
                            const request = {
                                location: userLocation,
                                radius: radiusInMeters.toString(),
                                type: ['restaurant'],
                                keyword: query,
                                fields: ['name', 'geometry', 'place_id', 'rating', 'user_ratings_total', 'vicinity', 'price_level']
                            };
                
                            placesService.nearbySearch(request, function (results, status) {
                                if (status === google.maps.places.PlacesServiceStatus.OK) {
                                    if (specificRestaurant) {
                                        // Filter results to show only the specific restaurant
                                        results = results.filter(
                                            (place) => place.name.toLowerCase() === query.toLowerCase()
                                        );
                                    }
                                    currentResults = results;
                                    displayResults(results);
                                } else {
                                    console.log('Search failed:', status);
                                    displayNoResults(status);
                                }
                            });
                        }, function (error) {
                            console.log('Geolocation error:', error);
                            displayError("Unable to get your location. Please make sure location services are enabled.");
                        });
                    } else {
                        console.log('Geolocation is not supported by this browser.');
                        displayError("Geolocation is not supported by your browser.");
                    }
                }

                // Declare global variables for icons
                const defaultMarkerIcon = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'; // Default red icon
                const activeMarkerIcon = 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'; // Blue icon for active marker
                
                let activeMarkerIndex = null; // To track the currently active marker
                
                function displayResults(results) {
                    const resultsList = document.getElementById('results-list');
                    resultsList.innerHTML = ''; // Clear previous results
                    map.setCenter({ lat: userPosition.coords.latitude, lng: userPosition.coords.longitude }); // Center map on user location
                
                    // Clear map markers
                    clearMarkers();
                
                    results.forEach(function(place, index) {
                        const card = document.createElement('div');
                        card.className = 'restaurant-card';
                        card.id = `restaurant-${index}`;
                        
                        const addressInput = place.formatted_address
                        const rating = place.rating || 0;
                        const fullStars = Math.floor(rating);
                        const halfStar = rating % 1 >= 0.5 ? 1 : 0;
                        const emptyStars = 5 - fullStars - halfStar;
                
                        const starHTML = '<i class="material-icons" style="color:#434343; font-size:16px; vertical-align:-2.5px;">star</i>'.repeat(fullStars) +
                            (halfStar ? '<i class="material-icons" style="color:#434343; font-size:16px; vertical-align:-2.5px;">star_half</i>' : '') +
                            '<i class="material-icons" style="color:#434343; font-size:16px; vertical-align:-2.5px;">star_border</i>'.repeat(emptyStars);
                
                        const distance = calculateDistance(place.geometry.location, userPosition);
                        place.distance = distance; // Store distance for sorting
                
                        // Create marker for each restaurant
                        let marker = new google.maps.Marker({
                            position: place.geometry.location,
                            map: map,
                            title: place.name,
                            icon: defaultMarkerIcon // Set default red icon
                        });
                        markers.push(marker);
                
                        // Add click event to marker
                        marker.addListener('click', function() {
                            // Collapse any open details
                            document.querySelectorAll('.details').forEach(function(details) {
                                details.style.display = 'none'; // Collapse all open details
                            });

                            // Scroll to the current restaurant card
                            const card = document.getElementById(`restaurant-${index}`);
                            card.scrollIntoView({ behavior: 'smooth', block: 'start' }); // Scroll to the restaurant card

                            // Expand the details of the current restaurant
                            const detailsDiv = document.getElementById(`details-${index}`);
                            if (detailsDiv.style.display === 'none') {
                                detailsDiv.style.display = 'block'; // Show the details
                                fetchAdditionalDetails(place.place_id, detailsDiv, place.name); // Fetch details if necessary
                            }

                            // Change the current marker to blue and reset others to red
                            setActiveMarker(marker, index);

                            // Get the marker's position and the current center
                            const markerPosition = marker.getPosition();
                            const currentCenter = map.getCenter();

                            // Only pan if the marker is not already in the center
                            if (currentCenter.lat() !== markerPosition.lat() || currentCenter.lng() !== markerPosition.lng()) {
                                map.panTo(markerPosition); // Smoothly pan to the marker's position
                            }

                            // Set the zoom level after panning to prevent jumping
                            setTimeout(() => {
                                map.setZoom(15); // Adjust the zoom level to 15
                            }, 100); // Delay the zoom adjustment slightly

                            // Update the toggle button text to "Hide Details"
                            const toggleButton = card.querySelector('.toggle-details');
                            toggleButton.textContent = 'Hide Details'; // Change button text to "Hide Details"
                        });


                        card.innerHTML = `
                            <h3 style="display: inline;">${place.name}</h3>
                            <button style="float: right;" class="favorite-button" data-restaurant-id="${place.place_id}" data-restaurant-name="${place.name}" data-restaurant-rating="${rating}" data-restaurant-address="${addressInput}">
                                <i class="material-icons">favorite</i>  Favorite
                            </button>
                            <p>Rating: ${starHTML} (${place.user_ratings_total || 0} reviews)</p>
                            <p>Distance: ${distance} mi</p>
                            <p class="toggle-details" style="cursor:pointer; color:blue;">Show Details</p>
                            
                            <div id="details-${index}" class="details" style="display:none;"></div>
                        `;
                
                        resultsList.appendChild(card); // Append card to the results list
                
                        // Add click event to toggle details
                        card.querySelector('.toggle-details').addEventListener('click', function() {
                            // Get the current details div for this card
                            const detailsDiv = document.getElementById(`details-${index}`);
                            
                            // Get the current button
                            const toggleButton = card.querySelector('.toggle-details');
                        
                            // Check if the current details are already open
                            const isCurrentlyOpen = detailsDiv.style.display === 'block';
                        
                            // Collapse all other details and change their buttons to "Show Details"
                            document.querySelectorAll('.details').forEach(function(div) {
                                div.style.display = 'none';
                            });
                            document.querySelectorAll('.toggle-details').forEach(function(button) {
                                button.textContent = 'Show Details';
                            });
                        
                            // Toggle the current card's details
                            if (isCurrentlyOpen) {
                                detailsDiv.style.display = 'none'; // Hide current details
                                toggleButton.textContent = 'Show Details'; // Change button text back to "Show Details"
                                resetMarkerToRed(marker); // Set marker back to red when the card is closed
                            } else {
                                detailsDiv.style.display = 'block'; // Show current details
                                toggleButton.textContent = 'Hide Details'; // Change button text to "Hide Details"
                                fetchAdditionalDetails(place.place_id, detailsDiv, place.name);
                                setActiveMarker(marker, index); // Set marker to blue
                        
                                // Smoothly pan to the marker instead of jumping
                                const markerPosition = marker.getPosition();
                                const currentCenter = map.getCenter();
                        
                                // Only pan if the marker is not already in the center
                                if (currentCenter.lat() !== markerPosition.lat() || currentCenter.lng() !== markerPosition.lng()) {
                                    map.panTo(markerPosition); // Smoothly pan to the marker's position
                                }
                        
                                // Set the zoom level after panning to prevent jumping
                                setTimeout(() => {
                                    map.setZoom(15); // Adjust the zoom level to 15
                                }, 100); // Delay the zoom adjustment slightly
                            }
                        });
                    });
                
                    // Add event listeners to the favorite buttons
                    document.querySelectorAll('.favorite-button').forEach(button => {
                        button.addEventListener('click', function(event) {
                            event.preventDefault(); // Prevent page reload
                            const restaurantId = this.getAttribute('data-restaurant-id');
                            const restaurantName = this.getAttribute('data-restaurant-name');
                            const restaurantRating = this.getAttribute('data-restaurant-rating');
                
                            // Send AJAX request to favorite/unfavorite the restaurant
                            fetch("{% url 'favorite_restaurant' %}", {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                },
                                body: 'restaurant_id=${restaurantId}&restaurant_name=${restaurantName}&restaurant_rating=${restaurantRating}'
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'favorited') {
                                    this.innerHTML = '<i class="material-icons">favorite_border</i> Unfavorite';
                                } else {
                                    this.innerHTML = '<i class="material-icons">favorite</i> Favorite';
                                }
                            })
                            .catch(error => console.error('Error:', error));
                        });
                    });
                
                    // Show sorting options
                    document.getElementById('sort-options').style.display = 'block';
                }
                
                // Function to set the active marker and reset others
                function setActiveMarker(marker, index) {
                    // If a previous marker is active, reset its icon to the default icon
                    if (activeMarkerIndex !== null && activeMarkerIndex !== index) {
                        markers[activeMarkerIndex].setIcon(defaultMarkerIcon); // Reset to default red icon
                    }
                
                    // Set the current marker to blue
                    marker.setIcon(activeMarkerIcon); // Set to blue icon
                
                    activeMarkerIndex = index; // Update the active marker index
                }
                
                // Function to reset marker to red when a card is closed
                function resetMarkerToRed(marker) {
                    marker.setIcon(defaultMarkerIcon); // Set back to red icon
                }
                
                function fetchAdditionalDetails(placeId, detailsDiv, place_name) {
                    const detailsRequest = {
                        placeId: placeId,
                        fields: ['formatted_address', 'formatted_phone_number', 'rating', 'reviews', 'types', 'geometry']
                    };
                
                    placesService.getDetails(detailsRequest, function(placeDetails, status) {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            const address = placeDetails.formatted_address || 'Address not available';
                            const phone = placeDetails.formatted_phone_number || 'Contact info not available';
                            const rating = placeDetails.rating || 'Rating not available';
                            
                            
                            const reviews = placeDetails.reviews || [];
                            
                            
                            const latitude = placeDetails.geometry?.location?.lat();
                            const longitude = placeDetails.geometry?.location?.lng();

                
                            const cuisineMapping = { "Italian": [ "Pizza", "Pasta", "Risotto", "Lasagna", "Focaccia", "Gelato", "Tiramisu", "Gnocchi", "Bruschetta", "Arancini", "Caprese", "Pesto", "Ragu", "Polenta", "Bolognese", "Cappuccino", "Cannoli", "Profiteroles", "Truffle", "Saffron", "Olive oil", "Parmesan", "Mozzarella", "Basil", "Tomato", "Garlic", "Prosciutto", "Salami", "Fennel", "Artichoke", "Eggplant", "Zucchini", "Pine nuts", "Vermouth", "Chianti", "Lambrusco", "Sangria", "Limoncello", "Crostini", "Panzanella", "Pasta e Fagioli", "Frittata", "Cicoria", "Polpette", "Speck", "Porcini", "Tartufo", "Stracciatella", "Sgombro", "Vongole", "Coda alla Vaccinara", "Baccala", "Fagioli", "Ribollita", "Sgombro", "Pici", "Trofie", "Pasta alla Norma", "Spaghetti Carbonara", "Tortellini", "Farinata", "Gamberetti", "Sgombro", "Branzino", "Cacciucco", "Riso al Salto", "Sgombro", "Cime di Rapa", "Burrata", "Panzanella", "Penne", "cocina", "latina", "Fusilli", "Tagliatelle", "Riso", "Cavolo Nero", "Aceto Balsamico", "Guanciale", "Lardo", "Nduja", "Castagne", "Olio di Oliva", "Frutta Secca", "Zafferano", "Cacciatore", "Scamorza", "Pasta Frolla", "Coccio", "Minestrone", "Sanguinaccio", "Biscotti", "Zabaglione", "Sgombro", "Torta della Nonna" ], "Mexican": [ "Tacos", "taco", "Burritos", "Enchiladas", "Tamales", "Guacamole", "Salsa", "Chiles Rellenos", "Quesadilla", "Nachos", "Chimichangas", "Mole", "Pozole", "Carnitas", "Ceviche", "Chalupas", "Tostadas", "Elote", "Flan", "Churros", "Frijoles", "Tortillas", "Pico de Gallo", "Lime", "Avocado", "Corn", "Chili", "Oregano", "Cilantro", "Sour Cream", "Pico de Gallo", "Agave", "Queso Fresco", "Jalapeño", "Chipotle", "Habanero", "Masa", "Barbacoa", "Puerco", "Aguachile", "Sopes", "Tinga", "Tamal", "Arroz", "Fajitas", "Cochinita Pibil", "Huaraches", "Cacahuate", "Nopales", "Cilantro", "Manteca", "Chorizo", "Banderillas", "Pambazo", "Calabacita", "Tinga", "Rajas", "Menudo", "Tamarindo", "Jamaica", "Tortilla Chips", "Sangria", "Tequila", "Sopes", "Masa Harina", "Camarones", "Lomo", "Oaxacan", "Taco Al Pastor", "Salsa Verde", "Pollo Asado", "Sopes", "Fresca", "Cazuela", "Tamales", "Nopales", "Agua Fresca", "Chiles en Nogada", "Pato", "Huitlacoche", "Salsita", "Barbacoa" ], "Chinese": [ "Dim Sum", "Kung Pao Chicken", "Sweet and Sour Pork", "Chow Mein", "Peking Duck", "Spring Rolls", "Wonton", "Szechuan", "Ma Po Tofu", "Fried Rice", "Hot Pot", "Dumplings", "Char Siu", "Bao", "Jiaozi", "Chow Fun", "Egg Tarts", "Sesame Chicken", "Beef Noodle Soup", "Lo Mein", "Pork Belly", "Rice Noodles", "Black Bean Sauce", "Oyster Sauce", "Hoisin Sauce", "Five Spice Powder", "Ginger", "Garlic", "Scallions", "Soy Sauce", "Tofu", "Chili Oil", "Bok Choy", "Chinese Broccoli", "Peanuts", "Sichuan Peppercorn", "Lemongrass", "Rice", "Sesame Oil", "Chili Paste", "Dried Shrimp", "Bamboo Shoots", "Cabbage", "Water Chestnuts", "Pork Dumplings", "Mapo Tofu", "Sichuan Noodles", "Steamed Buns", "Wonton Soup", "Chive Pancakes", "Nian Gao", "Zongzi", "Tangyuan", "Jellyfish Salad", "Pecking Duck", "Spicy Hot Pot", "Chinese BBQ", "Hakka Noodles", "Pork Ribs", "Sizzling Rice Soup", "Tea Eggs", "Lion's Head Meatballs", "Twice-Cooked Pork", "Scallion Pancakes", "Duck Sauce", "Hot and Sour Soup", "Egg Foo Young", "Xiaolongbao", "Fried Tofu", "Sweet Soy Sauce", "Tea Leaves", "Wok", "Stir Fry", "Pork Chops", "Mongolian Beef", "Peking Sauce", "Fried Noodles", "Shumai", "Ketchup" ], "Indian": [ "Biryani", "Butter Chicken", "Samosas", "Dosas", "Tandoori Chicken", "Paneer", "Chaat", "Raita", "Naan", "Korma", "Vindaloo", "Palak Paneer", "Dal", "Aloo Gobi", "Chole Bhature", "Lassi", "Pav Bhaji", "Vada Pav", "Pani Puri", "Rogan Josh", "Dhokla", "Idli", "Kachori", "Gulab Jamun", "Jalebi", "Basmati Rice", "Curry", "Turmeric", "Cilantro", "Cardamom", "Ginger", "Garlic", "Mustard Seeds", "Cumin", "Chili Powder", "Fenugreek", "Coconut", "Tomato", "Onion", "Green Chili", "Potatoes", "Lentils", "Methi", "Paneer Tikka", "Chicken Biryani", "Malai Kofta", "Sambar", "Bhindi", "Kheer", "Baingan Bharta", "Methi Thepla", "Chikki", "Dumplings", "Tikka Masala", "Pulao", "Chana Masala", "Dum Aloo", "Aloo Tikki", "Tandoori Roti", "Chutney", "Papad", "Chili Chicken", "Garam Masala", "Kofta", "Samosa Chaat", "Murg Methi", "Chowk", "Bhelpuri", "Thali", "Chappal", "Bhaji", "Bhaji Pav", "Chole", "Puri", "Khichdi", "Vegetable Biryani", "Mirchi Ka Salan", "Panchmel Dal", "Gajar Ka Halwa", "Paneer Butter Masala", "Egg Curry", "Paneer Bhurji", "Shahi Paneer", "Masala Dosa", "Masala Chai", "Litti Chokha" ], "Japanese": [ "Sushi", "Ramen", "Tempura", "Tonkatsu", "Sashimi", "Miso", "Teriyaki", "Nigiri", "Udon", "Soba", "Yakitori", "Onigiri", "Donburi", "Gyoza", "Okonomiyaki", "Katsu", "Tamagoyaki", "Natto", "Wasabi", "Dashi", "Matcha", "Sake", "Nori", "Shoyu", "Mirin", "Tofu", "Edamame", "Kombu", "Shiitake", "Mochi", "Tsukemono", "Yakiniku", "Sukiyaki", "Zaru Soba", "Chawanmushi", "Yaki Imo", "Kushi Katsu", "Takoyaki", "Kappa Maki", "Futomaki", "Chirashi", "Kakigori", "Hōtō", "Ramen Noodles", "Yudofu", "Tori Nanban", "Yudofu", "Shimeji", "Kurobuta", "Yaki Niku", "Obento", "Katsu Don", "Ten Don", "Unagi", "Sukiyaki", "Japa Dog", "Ramen Burger", "Sake Bomb", "Shabu Shabu", "Karaage", "Kombucha", "Jellyfish", "Takowasa", "Furikake", "Kabocha", "Yuzu", "Yakiniku Sauce", "Miso Soup", "Umeboshi", "Tuna", "Saba", "Yaki Udon", "Ikura", "Fried Tofu", "Yaki Tori", "Agedashi Tofu", "Goya Champuru", "Taiyaki", "Curry Rice", "Goma", "Mentaiko", "Chirashi Sushi" ], "French": [ "Croissant", "Ratatouille", "Boeuf Bourguignon", "Crème Brûlée", "Quiche", "Macaron", "Tarte Tatin", "Coq au Vin", "Bouillabaisse", "Soupe à l'oignon", "Escargot", "Cassoulet", "Tartiflette", "Provence", "Mousse", "Choux", "Crepes", "Pâté", "Tian", "Tarte Flambée", "Chateaubriand", "Pâtisserie", "Foie Gras", "Eclairs", "Rillettes", "Salmon en Papillote", "Gratin", "Salade Niçoise", "Crêpe Suzette", "Moules", "Panisse", "Brioche", "Rillettes", "Pan Bagnat", "Aïoli", "Rognons", "Caillette", "Pissaladière", "Soufflé", "Flammekueche", "Ragoût", "Chanterelles", "Potatoes Dauphinoise", "Chateaubriand", "Aïoli", "Tartine", "Bouilli", "Duxelles", "Escudella", "Crème Caramel", "Cider", "Grenadine", "Ratafia", "Glace", "Bourgogne", "Vichyssoise", "Saucisson", "Sauerkraut", "Moules Marinières", "Tarte aux Pommes", "Salmon en Papillote", "Couscous", "Poularde", "Flan", "Galette", "Salmon Mousse", "Choux à la Crème", "Pâté en Croûte", "Pâté de Campagne", "Soufflé au Chocolat", "Flammekueche", "Crêpes", "Saucisse", "Beaujolais", "Camembert", "Riesling" ], "Thai": [ "Pad Thai", "Green Curry", "Tom Yum Soup", "Som Tum", "Massaman Curry", "Red Curry", "Tom Kha", "Panang Curry", "Sticky Rice", "Pad See Ew", "Larb", "Satay", "Khao Soi", "Mango Sticky Rice", "Spring Rolls", "Thai Basil", "Coconut Milk", "Lemongrass", "Chili", "Fish Sauce", "Tamarind", "Kaffir Lime", "Galangal", "Peanuts", "Rice Noodles", "Thai Eggplant", "Chili Paste", "Jasmine Rice", "Cucumber Salad", "Pineapple Fried Rice", "Basil Chicken", "Crispy Pork", "Yellow Curry", "Coconut Curry", "Pork Neck", "Pad Krapow", "Sambal", "Yum Nua", "Soi Cowboy", "Nam Prik", "Sriracha", "Crispy Duck", "Massaman", "Green Papaya", "Chili Sauce", "Pork Satay", "Thai Omelette", "Mango Salad", "Thai Tea", "Rice Porridge", "Rad Nah", "Baked Fish", "Coconut Pudding", "Thai Iced Tea", "Fried Fish", "Garlic Shrimp", "Vegetable Stir Fry", "Baked Shrimp", "Papaya Salad", "Sate", "Larb Moo", "Khao Niew", "Spicy Tofu", "Tom Yum", "Kaeng Phed", "Khao Soi", "Kaeng Som", "Pad Pak", "Pad Kaprao", "Khao Tom", "Gai Pad Med Mamuang", "Sukhothai", "Kanom Jeen", "Tung Tung", "Dried Fish", "Sangkhaya" ], "Spanish": [ "Paella", "Tapas", "Gazpacho", "Churros", "Tortilla Española", "Pimientos de Padrón", "Patatas Bravas", "Chorizo", "Sangria", "Pulpo a la Gallega", "Flan", "Croquetas", "Bocadillo", "Fabada Asturiana", "Salmorejo", "Tarta de Santiago", "Arroz Negro", "Pisto", "Calçots", "Cava", "Turrón", "Romesco", "Cochinillo", "Tortas de Aceite", "Pate de Foa", "Aceitunas", "Gambas al Ajillo", "Migas", "Sangre", "Alioli", "Caracoles", "Almejas", "Esparragos", "Sopa de Ajo", "Cocido", "Bocadillo de Calamares", "Tarta", "Trucha", "Sangria", "Vino", "Tortas", "Tarta de Queso", "Arroz a Banda", "Arroz con Leche", "Tarta", "Calamares", "Guiso", "Mollejas", "Torrijas", "Tarta de Santiago", "Chalaza", "Puerros", "Pimientos", "Papas", "Flan", "Choclo", "Calabacines", "Verde", "Albahaca", "Paprika", "Aceitunas", "Gambas", "Bebidas", "Cerveza", "Cava", "Pernil", "Chorizo", "Tortilla", "Flan", "Cebolla", "Judía", "Pimiento", "Rabo de Toro", "Berenjena", "Puerros", "Cebolla", "Pimiento", "Berza" ], "Greek": [ "Moussaka", "Souvlaki", "Tzatziki", "Baklava", "Feta", "Dolma", "Gyro", "Spanakopita", "Saganaki", "Horiatiki", "Kleftiko", "Kleftiko", "Avgolemono", "Kreatopita", "Loukoum", "Taramasalata", "Fava", "Choriatiki", "Pita", "Gigantes", "Keftedes", "Bougatsa", "Patzarosalata", "Kavourmas", "Tzatziki", "Yemista", "Kalamata", "Ouzo", "Tsipouro", "Soutzouk Loukou", "Baklava", "Choriatiki", "Baba Ganoush", "Galaktoboureko", "Panzanella", "Cacik", "Kalamari", "Feta Cheese", "Tahini", "Chickpeas", "Olives", "Cucumber", "Tomato", "Olive Oil", "Lamb", "Pork", "Eggplant", "Mint", "Pistachios", "Almonds", "Grape Leaves", "Greek Yogurt", "Spices", "Herbs", "Lemon", "Chili Flakes", "Honey", "Fennel", "Lemon Juice", "Baklava", "Kavourmas", "Pork Belly", "Paprika", "Seafood", "Nuts", "Olive Oil", "Honey", "Saffron", "Sea Bass", "Eggplant", "Pasta", "Vegetables", "Bitter Greens", "Wheat", "Cabbage", "Pine Nuts", "Sea Bream", "Oregano", "Raki" ], "Lebanese": [ "Hummus", "Tabbouleh", "Shawarma", "Kibbeh", "Falafel", "Baba Ganoush", "Fattoush", "Mujadara", "Labneh", "Pita", "Kefta", "Muhammara", "Manakish", "Samak", "Kousa Mahshi", "Fatayer", "Warak Enab", "Zaatar", "Kibbeh Nayyeh", "Tawouk", "Jibneh", "Hareeseh", "Freekeh", "Bamieh", "Sfiha", "Mamaliga", "Baklava", "Maamoul", "Awtar", "Fried Cauliflower", "Tahini", "Olive Oil", "Pine Nuts", "Cinnamon", "Allspice", "Rose Water", "Sour Cherry", "Saffron", "Cumin", "Sumac", "Zaatar", "Green Beans", "Beetroot", "Cabbage", "Eggplant", "Fish", "Pork", "Hara", "Olive", "Mushrooms", "Yogurt", "Rice", "Kibbeh Bil Sanieh", "Baba Ghanoush", "Sahlab", "Harissa", "Olives", "Foul Medames", "Za'atar Manakish", "Pine Nuts", "Labneh", "Fattoush Salad", "Stuffed Peppers", "Tiroko", "Freekeh", "Harees", "Lentils", "Honey", "Vegetable Stew", "Potatoes", "Kousa Mahshi", "Mansaf", "Mawla", "Eggplant Moussaka", "Saffron Rice" ], "American": [ "Hamburger", "Hot Dog", "Barbecue", "Fried Chicken", "Macaroni and Cheese", "Cornbread", "Buffalo Wings", "Clam Chowder", "Chili", "BBQ Ribs", "Apple Pie", "Cheesecake", "Pancakes", "Waffles", "Biscuits", "Gravy", "Potato Salad", "Caesar Salad", "Tater Tots", "Corn on the Cob", "S'mores", "Key Lime Pie", "New England Clam Bake", "Gumbo", "Jambalaya", "Pulled Pork", "Pork Belly", "Fish Fry", "Tacos", "Meatloaf", "Brisket", "Pork Chops", "Steak", "Fajitas", "Sloppy Joes", "Philly Cheesesteak", "Lobster Roll", "Cobb Salad", "Deviled Eggs", "Pimento Cheese", "Bagels", "Cream Cheese", "Eggs Benedict", "Doughnuts", "Brownies", "Sundae", "Milkshake", "Root Beer Float", "Chili Cheese Fries", "Nachos", "Fried Green Tomatoes", "Chicken Fried Steak", "Pot Roast", "Stuffed Peppers", "Baked Beans", "Taco Salad", "Pork Rinds", "Potato Chips", "Trail Mix", "Buffalo Cauliflower", "Pasta Salad", "Steamed Clams", "Chowder Fries", "Flatbread", "Beef Jerky", "Cheddar Cheese", "Sweet Tea", "Cranberry Sauce", "Pumpkin Pie", "Cheeseburger Soup", "Casserole", "Grits", "Stuffing", "Ranch Dressing", "Honey Mustard", "Salsa", "Chipotle", "Beet Salad", "Bangers and Mash", "Cincinnati Chili", "Minestrone", "Frog Legs", "Eggplant Parmesan", "Hot Wings", "Italian Beef", "Tuna Salad", "Vegetable Medley", "Sweet Potatoes", "Kale Salad", "Lentil Soup", "Quiche", "French Fries", "Cheese Fries", "Steamed Vegetables", "Chili Con Carne", "Peach Cobbler" ] };
                            
                
                            // Function to determine the cuisine based on the restaurant name
                            function determineCuisine(name) {
                                for (const [cuisine, keywords] of Object.entries(cuisineMapping)) {
                                    if (name && typeof name === 'string') {

                                        const normalizedKeywords = keywords.map(k => k.trim().toLowerCase());
                                        const normalizedName = name.trim().toLowerCase();

                                        if (normalizedKeywords.some(keyword => normalizedName.includes(keyword))) {
                                            return cuisine.charAt(0).toUpperCase() + cuisine.slice(1); // Capitalize the first letter
                                        }
                                    } else {
                                        break;
                                    }
                                }
                                return 'Cuisine type not available'; // Default if no match
                            }
                
                            const cuisineType = determineCuisine(place_name);
                          
                
                            detailsDiv.innerHTML = `
                                <p>Address: ${address}</p>
                                <p>Contact: ${phone}</p>                          
                                <p>Rating: ${rating}</p>
                                <button class="get-directions" 
                                        style="margin-top: 10px; cursor: pointer; color: black;"
                                        onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${latitude},${longitude}', '_blank')">
                                    Get Directions
                                </button>

                                <h4>Reviews:</h4>
                                <div class="reviews-container">
                                    <ul>
                                        ${reviews.map((review, index) => createReviewItem(review, index)).join('')}
                                    </ul>
                                </div>
                                <button class="collapse-details" style="margin-top: 10px; cursor: pointer; color: black;">Collapse</button>
                            `;

                            detailsDiv.querySelector('.reviews-container').offsetHeight;
                
                            // Add event listener for collapse button
                            detailsDiv.querySelector('.collapse-details').addEventListener('click', function() {
                                detailsDiv.style.display = 'none'; // Hide the details
                                                
                                // Reset the marker back to red
                                resetMarkerToRed(markers[activeMarkerIndex]);
                                activeMarkerIndex = null; // Reset active marker index
                            });
                
                            reviews.forEach((review, index) => {
                                const moreButton = detailsDiv.querySelector(`#review-${index} .more-button`);
                                if (moreButton) {
                                    moreButton.addEventListener('click', function() {
                                        const fullReview = detailsDiv.querySelector(`#review-${index} .full-review`);
                                        const reviewTextElement = detailsDiv.querySelector(`#review-text-${index}`);
                                        
                                        // Only append the part of the full review that is not already displayed
                                        const partialText = reviewTextElement.innerHTML.replace('...', '').trim();  // Remove '...' and trim the string
                                        const fullReviewText = fullReview.innerHTML.trim();

                                        if (!partialText.includes(fullReviewText)) {
                                            const remainingText = fullReviewText.substring(partialText.length);  // Get the rest of the full review
                                            reviewTextElement.innerHTML = partialText + remainingText;  // Append the remaining text
                                        }

                                        fullReview.style.display = 'none'; // Hide the full review text
                                        moreButton.style.display = 'none'; // Hide the "More" button
                                    });
                                }
                            });
                        } else {
                            detailsDiv.innerHTML = `<p>Error fetching details: ${status}</p>`;
                        }
                    });
                }
                
                
                function createReviewItem(review, index) {
                    const fullText = review.text; // Get the full review text
                    const textLimit = 180;
                    const truncatedText = fullText.length > textLimit ? fullText.substring(0, textLimit) + '...' : fullText;
                
                    const rating = review.rating || 0; // Get the reviewer rating
                    const fullStars = Math.floor(rating);
                    const halfStar = rating % 1 >= 0.5 ? 1 : 0;
                    const emptyStars = 5 - fullStars - halfStar;

                    const starHTML = '<i class="material-icons" style="color:#434343; font-size:16px; vertical-align:-2.5px;">star</i>'.repeat(fullStars) +
                        (halfStar ? '<i class="material-icons" style="color:#434343; font-size:16px; vertical-align:-2.5px;">star_half</i>' : '') +
                        '<i class="material-icons" style="color:#434343; font-size:16px; vertical-align:-2.5px;">star_border</i>'.repeat(emptyStars);
                    
                    return `
                        <li id="review-${index}">
                            <div style="display:flex; align-items:center;">
                                <img src="${review.profile_photo_url}" alt="${review.author_name}'s profile picture" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                                <span><strong>${review.author_name} (${starHTML})</strong></span> <!-- Added star rating here -->
                            </div>
                            <p id="review-text-${index}">${truncatedText}</p>
                            ${fullText.length > textLimit ? `<button class="more-button" style="cursor: pointer; color: blue;">More</button>` : ''}
                            <span style="display:none;" class="full-review">${fullText}</span>
                        </li>
                    `;
                }

                // Returns distance in miles
                function calculateDistance(placeLocation, userPosition) {
                    if (!google.maps.geometry) {
                        console.error('Geometry library not loaded');
                        return 'N/A';
                    }
                    
                    const userLatLng = new google.maps.LatLng(
                        userPosition.coords.latitude,
                        userPosition.coords.longitude
                    );
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, placeLocation);
                    return (distance / 1000 / 1.609).toFixed(2); // Convert meters to miles and round to 2 decimal places
                }

                function sortAndDisplayResults(sortBy) {
                    let sortedResults = [...currentResults];
                    switch(sortBy) {
                        case 'price':
                            sortedResults.sort((a, b) => (a.price_level || 0) - (b.price_level || 0));
                            break;
                        case 'distance':
                            sortedResults.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
                            break;
                        case 'rating':
                            sortedResults.sort((a, b) => b.rating - a.rating);
                            break;
                        default:
                            // Default sorting (e.g., by relevance) is already applied by the API
                            break;
                    }
                    displayResults(sortedResults);
                }

                function displayNoResults(status) {
                    const resultsList = document.getElementById('results-list');
                    resultsList.innerHTML = `<p>No restaurants found. (Status: ${status}) - REMOVE IN PROD</p>`;
                    document.getElementById('sort-options').style.display = 'none';
                }

                function displayError(message) {
                    const resultsList = document.getElementById('results-list');
                    resultsList.innerHTML = `<p>Error: ${message}</p>`;
                    document.getElementById('sort-options').style.display = 'none';
                }

                // Load the Google Maps API script
                function loadGoogleMapsApi() {
                    const script = document.createElement('script');
                    script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBbMTTvhF3t8FS6IwjcIaNvHZq18k9y7sc&libraries=places,geometry&callback=initMap';
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                }

                // Call loadGoogleMapsApi when the page loads
                window.onload = loadGoogleMapsApi;
            </script>
        </div>
    </div>
{% endblock %}


